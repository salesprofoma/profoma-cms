<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profoma Admin – Aanvragen & Offertes</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    * { box-sizing: border-box; }
    body { margin:0; font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#f6faf9; color:#0f172a; }
    .wrap { max-width:1200px; margin:0 auto; padding:22px 16px 60px; }
    .topbar { display:flex; gap:12px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap; margin-bottom:14px; }
    h1 { margin:0; font-size:20px; }
    .muted { color:#64748b; font-size:12px; }
    .card { background:#fff; border:1px solid #e2e8f0; border-radius:16px; box-shadow:0 12px 34px rgba(15,23,42,0.06); padding:14px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tab { border:1px solid #e2e8f0; background:#fff; padding:8px 12px; border-radius:999px; cursor:pointer; font-weight:600; font-size:12px; color:#0f172a; }
    .tab.active { border-color:#0ea5a8; box-shadow:0 10px 26px rgba(14,165,168,0.18); }
    input, select { border:1px solid #e2e8f0; border-radius:10px; padding:9px 10px; font-size:12px; outline:none; }
    input:focus, select:focus { border-color:#0ea5a8; box-shadow:0 0 0 1px rgba(14,165,168,0.18); }
    .btn { border:none; border-radius:10px; padding:10px 12px; font-size:12px; cursor:pointer; font-weight:700; background:linear-gradient(135deg,#0ea5a8,#0f766e); color:#fff; }
    .btn.secondary { background:#0f172a; }
    .status { font-size:12px; color:#64748b; }
    .table { width:100%; border-collapse:collapse; margin-top:12px; overflow:hidden; border-radius:12px; }
    .table th, .table td { border-bottom:1px solid #eef2f7; padding:10px 10px; font-size:12px; vertical-align:top; }
    .table th { text-align:left; color:#334155; font-size:11px; letter-spacing:.04em; text-transform:uppercase; background:#f8fafc; }
    .pill { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-size:11px; border:1px solid #e2e8f0; background:#fff; }
    .pill.new { border-color:#bae6fd; background:#ecfeff; color:#0e7490; }
    .pill.work { border-color:#bbf7d0; background:#f0fdf4; color:#166534; }
    .pill.done { border-color:#e9d5ff; background:#faf5ff; color:#6b21a8; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .details { max-width:520px; }
    .kv { display:grid; grid-template-columns: 160px 1fr; gap:6px 10px; }
    .kv div { font-size:12px; }
    .kv .k { color:#64748b; }
    .kv .v { color:#0f172a; word-break:break-word; }
    .small { font-size:11px; color:#64748b; }
    .hide { display:none; }
    @media (max-width: 760px) {
      .kv { grid-template-columns: 1fr; }
      .details { max-width:unset; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Profoma Admin</h1>
        <div class="muted">Aanvragen (housing) & Offertes. Status bijwerken, zoeken en filteren.</div>
      </div>

      <div class="row">
        <input id="adminToken" type="password" placeholder="ADMIN_TOKEN (aanrader)" style="min-width:240px" />
        <button class="btn secondary" id="saveTokenBtn">Token opslaan</button>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div class="tabs">
          <button class="tab active" data-tab="requests">Aanvragen (Housing)</button>
          <button class="tab" data-tab="offertes">Offertes</button>
        </div>

        <div class="row">
          <input id="search" type="text" placeholder="Zoeken (bedrijf, email, locatie, etc.)" style="min-width:260px" />
          <select id="statusFilter">
            <option value="">Alle statussen</option>
            <option value="Nieuw">Nieuw</option>
            <option value="In behandeling">In behandeling</option>
            <option value="Gepland">Gepland</option>
            <option value="Afgerond">Afgerond</option>
          </select>
          <button class="btn" id="refreshBtn">Ververs</button>
          <span class="status" id="statusText"></span>
        </div>
      </div>

      <div id="pane-requests">
        <table class="table" id="requestsTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Bedrijf</th>
              <th>Contact</th>
              <th>Regio</th>
              <th>Check-in</th>
              <th>Personen</th>
              <th>Status</th>
              <th>Actie</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="pane-offertes" class="hide">
        <table class="table" id="offertesTable">
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Datum</th>
              <th>Status</th>
              <th>Actie</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: zet in Render een ENV <span class="mono">ADMIN_TOKEN</span>. Dit dashboard stuurt de token mee als <span class="mono">x-admin-token</span>.
      </div>
    </div>
  </div>

  <script>
    const API_BASE = ""; // zelfde domain als je backend (Render). Als je admin via backend serve't is dit goed zo.

    const els = {
      tabs: document.querySelectorAll("[data-tab]"),
      paneRequests: document.getElementById("pane-requests"),
      paneOffertes: document.getElementById("pane-offertes"),
      search: document.getElementById("search"),
      statusFilter: document.getElementById("statusFilter"),
      refreshBtn: document.getElementById("refreshBtn"),
      statusText: document.getElementById("statusText"),
      requestsTbody: document.querySelector("#requestsTable tbody"),
      offertesTbody: document.querySelector("#offertesTable tbody"),
      adminToken: document.getElementById("adminToken"),
      saveTokenBtn: document.getElementById("saveTokenBtn"),
    };

    function getToken() {
      return localStorage.getItem("PROFOMA_ADMIN_TOKEN") || "";
    }
    function setToken(t) {
      localStorage.setItem("PROFOMA_ADMIN_TOKEN", t || "");
    }

    els.adminToken.value = getToken();
    els.saveTokenBtn.addEventListener("click", () => {
      setToken(els.adminToken.value.trim());
      toast("Token opgeslagen.", false);
    });

    function headers() {
      const t = (els.adminToken.value || getToken() || "").trim();
      const h = { "Content-Type": "application/json", "Accept": "application/json" };
      if (t) h["x-admin-token"] = t;
      return h;
    }

    function toast(msg, isErr) {
      els.statusText.textContent = msg;
      els.statusText.style.color = isErr ? "#b23333" : "#0f766e";
      setTimeout(() => { els.statusText.textContent = ""; els.statusText.style.color = "#64748b"; }, 3000);
    }

    function pill(status) {
      const s = String(status || "Nieuw");
      let cls = "pill new";
      if (/behandeling|gepland/i.test(s)) cls = "pill work";
      if (/afgerond|done/i.test(s)) cls = "pill done";
      return `<span class="${cls}">${escapeHtml(s)}</span>`;
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function matchSearch(row, q) {
      if (!q) return true;
      const hay = JSON.stringify(row).toLowerCase();
      return hay.includes(q.toLowerCase());
    }

    function matchStatus(row, status) {
      if (!status) return true;
      return String(row.status || "").toLowerCase() === String(status).toLowerCase();
    }

    async function apiGet(path) {
      const res = await fetch(API_BASE + path, { headers: headers() });
      const txt = await res.text();
      let json = null; try { json = JSON.parse(txt); } catch {}
      if (!res.ok) throw new Error(json?.error || txt || `HTTP ${res.status}`);
      return json;
    }

    async function apiPatch(path, body) {
      const res = await fetch(API_BASE + path, { method: "PATCH", headers: headers(), body: JSON.stringify(body) });
      const txt = await res.text();
      let json = null; try { json = JSON.parse(txt); } catch {}
      if (!res.ok) throw new Error(json?.error || txt || `HTTP ${res.status}`);
      return json;
    }

    function renderRequests(rows) {
      const q = (els.search.value || "").trim();
      const sf = (els.statusFilter.value || "").trim();

      const filtered = (rows || []).filter(r => matchSearch(r, q) && matchStatus(r, sf));

      els.requestsTbody.innerHTML = filtered.map(r => {
        const created = r.createdAt ? new Date(r.createdAt).toLocaleString("nl-NL") : "";
        const inc = (() => { try {
          const arr = JSON.parse(r.included || "[]");
          return Array.isArray(arr) ? arr.join(", ") : String(r.included || "");
        } catch { return String(r.included || ""); } })();

        return `
          <tr>
            <td class="mono">#${escapeHtml(r.id)}</td>
            <td>
              <div><b>${escapeHtml(r.company || "-")}</b></div>
              <div class="small">${escapeHtml(created)}</div>
            </td>
            <td>
              <div>${escapeHtml(r.contactPerson || "-")}</div>
              <div class="small">${escapeHtml(r.email || "")} · ${escapeHtml(r.phone || "")}</div>
            </td>
            <td>${escapeHtml(r.region || "-")}</td>
            <td>${escapeHtml(r.checkin || "-")}</td>
            <td>${escapeHtml(r.totalPersons ?? "-")}</td>
            <td>${pill(r.status)}</td>
            <td>
              <select data-set-status-req="${escapeHtml(r.id)}">
                <option ${r.status==="Nieuw"?"selected":""}>Nieuw</option>
                <option ${r.status==="In behandeling"?"selected":""}>In behandeling</option>
                <option ${r.status==="Gepland"?"selected":""}>Gepland</option>
                <option ${r.status==="Afgerond"?"selected":""}>Afgerond</option>
              </select>
            </td>
            <td class="details">
              <div class="kv">
                <div class="k">Duur</div><div class="v">${escapeHtml(r.duration || "-")}</div>
                <div class="k">Per kamer</div><div class="v">${escapeHtml(r.personsPerRoom || "-")}</div>
                <div class="k">Budget</div><div class="v">${escapeHtml(r.budget || "-")}</div>
                <div class="k">Inbegrepen</div><div class="v">${escapeHtml(inc || "-")}</div>
                <div class="k">Notities</div><div class="v">${escapeHtml(r.notes || "-")}</div>
              </div>
            </td>
          </tr>
        `;
      }).join("");

      // bind status change
      document.querySelectorAll("[data-set-status-req]").forEach(sel => {
        sel.addEventListener("change", async () => {
          const id = sel.getAttribute("data-set-status-req");
          try {
            await apiPatch(`/api/requests/${id}/status`, { status: sel.value });
            toast(`Request #${id} bijgewerkt.`, false);
          } catch (e) {
            toast(String(e.message || e), true);
          }
        });
      });
    }

    function renderOffertes(rows) {
      const q = (els.search.value || "").trim();
      const sf = (els.statusFilter.value || "").trim();

      const filtered = (rows || []).filter(r => matchSearch(r, q) && matchStatus(r, sf));

      els.offertesTbody.innerHTML = filtered.map(r => {
        const created = r.createdAt ? new Date(r.createdAt).toLocaleString("nl-NL") : "";
        const data = r.data || {};
        const compact = Object.entries(data).slice(0, 8).map(([k,v]) => {
          const val = Array.isArray(v) ? v.join(", ") : String(v ?? "");
          return `<div><span class="small">${escapeHtml(k)}:</span> ${escapeHtml(val)}</div>`;
        }).join("");

        return `
          <tr>
            <td class="mono">#${escapeHtml(r.id)}</td>
            <td><b>${escapeHtml(r.typeAanvraag || "-")}</b></td>
            <td>${escapeHtml(created)}</td>
            <td>${pill(r.status)}</td>
            <td>
              <select data-set-status-off="${escapeHtml(r.id)}">
                <option ${r.status==="Nieuw"?"selected":""}>Nieuw</option>
                <option ${r.status==="In behandeling"?"selected":""}>In behandeling</option>
                <option ${r.status==="Gepland"?"selected":""}>Gepland</option>
                <option ${r.status==="Afgerond"?"selected":""}>Afgerond</option>
              </select>
            </td>
            <td class="details">
              ${compact || "<span class='small'>—</span>"}
              <div class="small" style="margin-top:6px;">(Toont eerste velden; alle data zit in DB)</div>
            </td>
          </tr>
        `;
      }).join("");

      document.querySelectorAll("[data-set-status-off]").forEach(sel => {
        sel.addEventListener("change", async () => {
          const id = sel.getAttribute("data-set-status-off");
          try {
            await apiPatch(`/api/offertes/${id}/status`, { status: sel.value });
            toast(`Offerte #${id} bijgewerkt.`, false);
          } catch (e) {
            toast(String(e.message || e), true);
          }
        });
      });
    }

    let cacheRequests = [];
    let cacheOffertes = [];

    async function loadAll() {
      try {
        toast("Ophalen...", false);
        const [req, off] = await Promise.all([
          apiGet("/api/requests"),
          apiGet("/api/offertes"),
        ]);

        cacheRequests = req.data || [];
        cacheOffertes = off.data || [];

        // render active tab
        const activeTab = document.querySelector(".tab.active")?.getAttribute("data-tab");
        if (activeTab === "offertes") renderOffertes(cacheOffertes);
        else renderRequests(cacheRequests);

        toast("Bijgewerkt.", false);
      } catch (e) {
        toast(String(e.message || e), true);
      }
    }

    // Tabs
    els.tabs.forEach(t => {
      t.addEventListener("click", () => {
        els.tabs.forEach(x => x.classList.remove("active"));
        t.classList.add("active");

        const tab = t.getAttribute("data-tab");
        els.paneRequests.classList.toggle("hide", tab !== "requests");
        els.paneOffertes.classList.toggle("hide", tab !== "offertes");

        if (tab === "offertes") renderOffertes(cacheOffertes);
        else renderRequests(cacheRequests);
      });
    });

    // Filters
    els.search.addEventListener("input", () => {
      const activeTab = document.querySelector(".tab.active")?.getAttribute("data-tab");
      if (activeTab === "offertes") renderOffertes(cacheOffertes);
      else renderRequests(cacheRequests);
    });
    els.statusFilter.addEventListener("change", () => {
      const activeTab = document.querySelector(".tab.active")?.getAttribute("data-tab");
      if (activeTab === "offertes") renderOffertes(cacheOffertes);
      else renderRequests(cacheRequests);
    });

    els.refreshBtn.addEventListener("click", loadAll);

    // init
    loadAll();
  </script>
</body>
</html>
