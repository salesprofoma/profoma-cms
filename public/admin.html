<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profoma Admin – Aanvragen & Offertes</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    *{box-sizing:border-box}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#f6faf9;color:#0f172a}
    .wrap{max-width:1200px;margin:0 auto;padding:22px 16px 60px}
    .topbar{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:14px}
    h1{margin:0;font-size:20px}
    .muted{color:#64748b;font-size:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:0;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:linear-gradient(135deg,#00a3b4,#006b8f);color:#fff}
    .btn.secondary{background:#0f172a}
    .btn.light{background:#ffffff;color:#0f172a;border:1px solid #e2ece9}
    .card{background:#fff;border:1px solid #e2ece9;border-radius:16px;box-shadow:0 14px 34px rgba(15,23,42,.06);padding:14px;margin-top:12px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{border:1px solid #e2ece9;background:#fff;border-radius:999px;padding:8px 12px;font-weight:700;font-size:12px;cursor:pointer}
    .tab.active{border-color:#00a3b4;box-shadow:0 10px 26px rgba(0,163,180,.14)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    input,select{border:1px solid #e2ece9;border-radius:12px;padding:9px 10px;font-size:12px;outline:none;background:#fff}
    table{width:100%;border-collapse:collapse;margin-top:10px;overflow:hidden;border-radius:12px}
    th,td{border-bottom:1px solid #eef2f7;padding:10px 10px;font-size:12px;vertical-align:top}
    th{background:#f8fafc;text-align:left;color:#334155;font-size:11px;letter-spacing:.02em;text-transform:uppercase}
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:11px;padding:4px 10px;border-radius:999px;border:1px solid #e2ece9;background:#fff}
    .pill.new{border-color:rgba(2,132,199,.35);background:rgba(2,132,199,.08);color:#075985}
    .pill.done{border-color:rgba(34,197,94,.35);background:rgba(34,197,94,.08);color:#166534}
    .pill.work{border-color:rgba(245,158,11,.35);background:rgba(245,158,11,.10);color:#92400e}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .link{color:#0284c7;text-decoration:none}
    .link:hover{text-decoration:underline}
    .detail{white-space:pre-wrap;background:#f6f7f9;border:1px solid #e5e7eb;border-radius:12px;padding:12px;font-size:12px;margin-top:10px;display:none}
    .detail.show{display:block}
    .note{font-size:12px;color:#64748b;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Profoma Admin</h1>
        <div class="muted">Aanvragen (housing) + Offertes (zakelijk / housing / particulier)</div>
      </div>
      <div class="row">
        <a class="btn light" href="/admin/export/requests.csv" target="_blank">Export Requests (CSV)</a>
        <a class="btn light" href="/admin/export/offers.csv" target="_blank">Export Offers (CSV)</a>
        <a class="btn secondary" href="/admin/logout">Uitloggen</a>
      </div>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="requests">Housing aanvragen</button>
        <button class="tab" data-tab="offers">Offertes</button>
      </div>

      <div class="controls">
        <input id="search" placeholder="Zoeken (naam, bedrijf, mail, locatie…)" />
        <select id="statusFilter">
          <option value="">Alle statussen</option>
          <option value="Nieuw">Nieuw</option>
          <option value="In behandeling">In behandeling</option>
          <option value="Gepland">Gepland</option>
          <option value="Afgerond">Afgerond</option>
        </select>
        <button class="btn" id="refresh">Vernieuwen</button>
        <div class="note" id="meta"></div>
      </div>

      <div id="panel-requests">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Bedrijf / Contact</th>
              <th>Regio</th>
              <th>Check-in</th>
              <th>Personen</th>
              <th>Budget</th>
              <th>Status</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody id="tbodyRequests"></tbody>
        </table>
      </div>

      <div id="panel-offers" style="display:none;">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Type</th>
              <th>Naam / Bedrijf</th>
              <th>Locatie</th>
              <th>Start</th>
              <th>Email / Tel</th>
              <th>Status</th>
              <th>Acties</th>
            </tr>
          </thead>
          <tbody id="tbodyOffers"></tbody>
        </table>

        <div class="detail" id="offerDetail"></div>
      </div>
    </div>
  </div>

<script>
(function () {
  const tabs = document.querySelectorAll(".tab");
  const panelRequests = document.getElementById("panel-requests");
  const panelOffers = document.getElementById("panel-offers");
  const tbodyRequests = document.getElementById("tbodyRequests");
  const tbodyOffers = document.getElementById("tbodyOffers");
  const offerDetail = document.getElementById("offerDetail");

  const searchEl = document.getElementById("search");
  const statusFilterEl = document.getElementById("statusFilter");
  const refreshBtn = document.getElementById("refresh");
  const metaEl = document.getElementById("meta");

  let activeTab = "requests";
  let dataRequests = [];
  let dataOffers = [];

  function pill(status) {
    const s = (status || "Nieuw");
    const cls = (s === "Afgerond") ? "done" : (s === "In behandeling" || s === "Gepland") ? "work" : "new";
    return `<span class="pill ${cls}">${escapeHtml(s)}</span>`;
  }

  function escapeHtml(s) {
    return String(s || "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function fmtDate(iso) {
    if (!iso) return "";
    try { return new Date(iso).toLocaleString("nl-NL"); } catch(e){ return iso; }
  }

  function matchesSearch(obj, q) {
    if (!q) return true;
    const text = JSON.stringify(obj || {}).toLowerCase();
    return text.includes(q.toLowerCase());
  }

  function matchesStatus(obj, status) {
    if (!status) return true;
    return String(obj.status || "") === status;
  }

  function renderMeta() {
    const count = activeTab === "requests" ? dataRequests.length : dataOffers.length;
    metaEl.textContent = `Totaal: ${count}`;
  }

  function renderRequests() {
    const q = searchEl.value.trim();
    const sf = statusFilterEl.value;

    const rows = dataRequests
      .filter(r => matchesSearch(r, q))
      .filter(r => matchesStatus(r, sf));

    tbodyRequests.innerHTML = rows.map(r => {
      const company = escapeHtml(r.company || "-");
      const contact = escapeHtml(r.contactPerson || "-");
      const email = escapeHtml(r.email || "");
      const phone = escapeHtml(r.phone || "");
      const region = escapeHtml(r.region || "-");
      const persons = escapeHtml(String(r.totalPersons || ""));
      const budget = escapeHtml(r.budget || "");
      const checkin = escapeHtml(r.checkin || "");
      const id = r.id;

      return `
        <tr>
          <td>${id}</td>
          <td>
            <b>${company}</b><br/>
            ${contact}<br/>
            <span class="muted">${email} ${phone ? " • " + phone : ""}</span><br/>
            <span class="muted">${fmtDate(r.createdAt)}</span>
          </td>
          <td>${region}</td>
          <td>${checkin}</td>
          <td>${persons}</td>
          <td>${budget}</td>
          <td>${pill(r.status)}</td>
          <td>
            <div class="actions">
              <select data-set-status-request="${id}">
                <option value="Nieuw" ${r.status==="Nieuw"?"selected":""}>Nieuw</option>
                <option value="In behandeling" ${r.status==="In behandeling"?"selected":""}>In behandeling</option>
                <option value="Afgerond" ${r.status==="Afgerond"?"selected":""}>Afgerond</option>
              </select>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll("[data-set-status-request]").forEach(sel => {
      sel.addEventListener("change", async () => {
        const id = sel.getAttribute("data-set-status-request");
        const status = sel.value;
        await fetch(`/api/requests/${id}/status`, {
          method: "PATCH",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ status })
        });
        await loadAll();
      });
    });

    renderMeta();
  }

  function renderOffers() {
    const q = searchEl.value.trim();
    const sf = statusFilterEl.value;

    const rows = dataOffers
      .filter(r => matchesSearch(r, q))
      .filter(r => matchesStatus(r, sf));

    tbodyOffers.innerHTML = rows.map(r => {
      const id = r.id;
      const type = escapeHtml(r.type || "");
      const name = escapeHtml(r.name || "-");
      const company = escapeHtml(r.company || "");
      const location = escapeHtml(r.location || "-");
      const startDate = escapeHtml(r.startDate || "");
      const email = escapeHtml(r.email || "");
      const phone = escapeHtml(r.phone || "");

      return `
        <tr>
          <td>${id}</td>
          <td><span class="pill">${type}</span></td>
          <td>
            <b>${name}</b>${company ? "<br/>" + company : ""}
            <br/><span class="muted">${fmtDate(r.createdAt)}</span>
          </td>
          <td>${location}</td>
          <td>${startDate}</td>
          <td><span class="muted">${email}${phone ? " • " + phone : ""}</span></td>
          <td>${pill(r.status)}</td>
          <td>
            <div class="actions">
              <button class="btn light" data-view-offer="${id}">Details</button>
              <select data-set-status-offer="${id}">
                <option value="Nieuw" ${r.status==="Nieuw"?"selected":""}>Nieuw</option>
                <option value="In behandeling" ${r.status==="In behandeling"?"selected":""}>In behandeling</option>
                <option value="Afgerond" ${r.status==="Afgerond"?"selected":""}>Afgerond</option>
              </select>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    document.querySelectorAll("[data-view-offer]").forEach(btn => {
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-view-offer");
        const res = await fetch(`/api/offers/${id}`);
        const out = await res.json();
        if (out && out.success && out.data) {
          const d = out.data;
          let details = {};
          try { details = JSON.parse(d.details || "{}"); } catch(e){ details = { raw: d.details }; }
          offerDetail.classList.add("show");
          offerDetail.textContent = JSON.stringify({ ...d, details }, null, 2);
          offerDetail.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      });
    });

    document.querySelectorAll("[data-set-status-offer]").forEach(sel => {
      sel.addEventListener("change", async () => {
        const id = sel.getAttribute("data-set-status-offer");
        const status = sel.value;
        await fetch(`/api/offers/${id}/status`, {
          method: "PATCH",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ status })
        });
        await loadAll();
      });
    });

    renderMeta();
  }

  async function loadAll() {
    offerDetail.classList.remove("show");
    offerDetail.textContent = "";

    const [reqRes, offRes] = await Promise.all([
      fetch("/api/requests"),
      fetch("/api/offers")
    ]);

    const reqOut = await reqRes.json().catch(() => ({}));
    const offOut = await offRes.json().catch(() => ({}));

    dataRequests = (reqOut && reqOut.success && Array.isArray(reqOut.data)) ? reqOut.data : [];
    dataOffers = (offOut && offOut.success && Array.isArray(offOut.data)) ? offOut.data : [];

    if (activeTab === "requests") renderRequests();
    else renderOffers();
  }

  tabs.forEach(t => {
    t.addEventListener("click", () => {
      tabs.forEach(x => x.classList.remove("active"));
      t.classList.add("active");
      activeTab = t.getAttribute("data-tab");

      panelRequests.style.display = (activeTab === "requests") ? "block" : "none";
      panelOffers.style.display = (activeTab === "offers") ? "block" : "none";

      if (activeTab === "requests") renderRequests();
      else renderOffers();
    });
  });

  refreshBtn.addEventListener("click", loadAll);
  searchEl.addEventListener("input", () => activeTab === "requests" ? renderRequests() : renderOffers());
  statusFilterEl.addEventListener("change", () => activeTab === "requests" ? renderRequests() : renderOffers());

  loadAll();
})();
</script>
</body>
</html>
